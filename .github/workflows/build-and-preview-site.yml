name: Build and Preview Site
on:
  pull_request:
        branches: [master]
        types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'
          extended: true

      - name: Install PostCSS
        run: |
          npm install -g postcss postcss-cli
          if [ -f "package.json" ]; then
            npm install
          fi

      - name: Build with Hugo
        run: |
          hugo mod clean
          hugo mod get -u
          hugo \
            --minify \
            --gc \
            --cleanDestinationDir \
            --ignoreVendorPaths "github.com/google/docsy"

      - name: Install Netlify CLI
        run: npm install -g netlify-cli

      - name: Deploy to Netlify
        id: netlify
        run: |
          # Authenticate with Netlify
          netlify deploy --prod --dir=public --site ${{ secrets.NETLIFY_SITE_ID }} --auth ${{ secrets.NETLIFY_AUTH_TOKEN }} --json > deploy-output.json
          
          # Extract deploy URL
          DEPLOY_ID=$(jq -r '.deploy_id' deploy-output.json)
          DEPLOY_URL=$(jq -r '.deploy_url' deploy-output.json)
          
          echo "deploy_id=$DEPLOY_ID" >> $GITHUB_OUTPUT
          echo "deploy_url=$DEPLOY_URL" >> $GITHUB_OUTPUT

      - name: Comment Deploy URL
        uses: ./.github/actions/comment-preview-on-pr
        with:
          token: ${{ secrets.GH_ACCESS_TOKEN }}
          deploy_url: "${{ steps.netlify.outputs.deploy-url }}"